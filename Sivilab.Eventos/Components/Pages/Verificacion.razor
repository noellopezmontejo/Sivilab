@page "/verificacion"
@page "/verificacion/{Folio}"
@layout Sivilab.Eventos.Components.Layout.EmptyLayout
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

<PageTitle>Verificación de Registro - EMPLEOTÓN CHIAPAS 2025</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10 col-md-12">
            <div class="card shadow-lg">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                    <h1 class="mb-0 text-center">
                        <i class="fas fa-check-circle me-3"></i>
                        VERIFICACIÓN DE REGISTRO
                    </h1>
                    <p class="text-center mb-0 mt-3 opacity-90 fs-6">
                        EMPLEOTÓN CHIAPAS 2025 - Servicio Nacional de Empleo
                    </p>
                </div>

                <div class="card-body p-4">
                    <!-- Mensaje de bienvenida y éxito -->
                    <div class="alert border-0 mb-4" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                        <div class="text-center">
                            <i class="fas fa-check-circle text-success" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3 class="text-success fw-bold mb-3">¡REGISTRO EXITOSO!</h3>
                            <p class="mb-2">
                                <strong>Bienvenido(a), @Nombre</strong>
                            </p>
                            <p class="mb-0">
                                <i class="fas fa-ticket-alt me-2"></i>
                                <strong>Folio de Registro:</strong> <span class="badge bg-primary fs-6">@Folio</span>
                            </p>
                        </div>
                    </div>

                    <!-- Instrucciones -->
                    <div class="alert alert-info border-0 mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <div class="text-center">
                            <i class="fas fa-envelope-open-text me-2" style="font-size: 2rem;"></i>
                            <h5 class="fw-bold mt-2 mb-3">Código de Verificación Enviado</h5>
                            <p class="mb-2">
                                Hemos enviado un código de verificación de <strong>6 dígitos</strong> a:
                            </p>
                            <p class="mb-3">
                                <i class="fas fa-envelope me-2"></i>
                                <strong class="text-primary">@Email</strong>
                            </p>
                            <p class="mb-0 small">
                                <i class="fas fa-info-circle me-1"></i>
                                Por favor, revise su bandeja de entrada y la carpeta de correo no deseado (spam).
                            </p>
                        </div>
                    </div>

                    <!-- Mensaje de alerta/éxito dinámico -->
                    @if (!string.IsNullOrEmpty(mensaje))
                    {
                        <div class="alert @GetAlertClass() alert-dismissible fade show" role="alert">
                            <i class="fas @GetAlertIcon() me-2"></i>
                            @mensaje
                            <button type="button" class="btn-close" @onclick="CerrarAlerta"></button>
                        </div>
                    }

                    <!-- Formulario -->
                    <EditForm Model="@verificacionModel" OnValidSubmit="VerificarCodigo" FormName="VerificacionForm">
                        <DataAnnotationsValidator />

                        <div class="card bg-light mb-4">
                            <div class="card-body p-4">
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <label for="codigoVerificacion" class="form-label fw-bold text-center d-block mb-3">
                                            <i class="fas fa-key me-2 text-primary"></i>
                                            INGRESE EL CÓDIGO DE VERIFICACIÓN
                                            <span class="text-danger">*</span>
                                        </label>

                                        <InputText @bind-Value="verificacionModel.CodigoVerificacion"
                                                   @oninput="OnCodigoInput"
                                                   class="form-control form-control-lg text-center"
                                                   placeholder="000000"
                                                   maxlength="6"
                                                   style="font-size: 2rem; letter-spacing: 0.5rem; font-family: 'Courier New', monospace; font-weight: bold;" />

                                        <div class="form-text text-center mt-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Código de 6 dígitos numéricos
                                        </div>

                                        <ValidationMessage For="@(() => verificacionModel.CodigoVerificacion)" class="text-danger text-center d-block" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none;">
                                <i class="fas fa-check-circle me-2"></i>VERIFICAR CÓDIGO
                            </button>
                        </div>

                        <div class="text-center">
                            <button type="button" class="btn btn-link text-decoration-none" @onclick="ReenviarCodigo">
                                <i class="fas fa-redo me-1"></i>
                                ¿No recibiste el código? Reenviar
                            </button>
                        </div>
                    </EditForm>

                    <!-- Información adicional -->
                    <div class="card border-warning mt-4">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-lightbulb me-2 text-warning"></i>
                                Consejos para encontrar tu código:
                            </h6>
                            <ul class="mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Revisa tu bandeja de entrada y la carpeta de spam
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    El correo proviene de: noreply@empleotonchiapas.gob.mx
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    El código tiene una validez de 15 minutos
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Si no lo encuentras, puedes solicitar un reenvío
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Botón para volver al inicio -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-outline-primary" @onclick='() => Navigation.NavigateTo("/")'>
                            <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? Folio { get; set; }

    [SupplyParameterFromQuery(Name = "nombre")]
    public string? Nombre { get; set; }

    [SupplyParameterFromQuery(Name = "email")]
    public string? Email { get; set; }

    [SupplyParameterFromForm]
    private VerificacionModel verificacionModel { get; set; } = new();

    private string mensaje = string.Empty;
    private string tipoMensaje = string.Empty;

    protected override void OnInitialized()
    {
        // Si no hay parámetros, redirigir al inicio
        if (string.IsNullOrEmpty(Folio) || string.IsNullOrEmpty(Email))
        {
            // Valores por defecto para pruebas
            Folio = "EMP-2025-DEMO";
            Email = "ejemplo@correo.com";
            Nombre = "Usuario Demo";
        }
    }

    private void OnCodigoInput(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString() ?? "";
        // Solo permitir números
        verificacionModel.CodigoVerificacion = new string(valor.Where(char.IsDigit).ToArray());
        if (verificacionModel.CodigoVerificacion.Length > 6)
        {
            verificacionModel.CodigoVerificacion = verificacionModel.CodigoVerificacion.Substring(0, 6);
        }
    }

    private async Task ReenviarCodigo()
    {
        bool confirmar = await JSRuntime.InvokeAsync<bool>("confirm", "¿Desea recibir un nuevo código de verificación?");

        if (confirmar)
        {
            MostrarMensaje("success", "Se ha enviado un nuevo código a su correo electrónico.");
            // TODO: Implementar llamada al backend para reenviar código
        }
    }

    private async Task VerificarCodigo()
    {
        if (string.IsNullOrEmpty(verificacionModel.CodigoVerificacion) || verificacionModel.CodigoVerificacion.Length != 6)
        {
            MostrarMensaje("danger", "Por favor, ingrese un código de verificación válido de 6 dígitos.");
            return;
        }

        try
        {
            // TODO: Aquí implementarías la lógica real de verificación con el backend
            // Por ahora simulamos una verificación exitosa

            MostrarMensaje("success", "¡Código verificado correctamente! Registro completado con éxito.");

            // Esperar 2 segundos y preguntar si desea volver al inicio
            await Task.Delay(2000);

            bool volverInicio = await JSRuntime.InvokeAsync<bool>("confirm", "Su registro ha sido completado. ¿Desea volver al inicio?");

            if (volverInicio)
            {
                Navigation.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            MostrarMensaje("danger", $"Error al verificar el código: {ex.Message}");
        }
    }

    private string GetAlertClass()
    {
        return tipoMensaje switch
        {
            "success" => "alert-success",
            "warning" => "alert-warning",
            "danger" => "alert-danger",
            _ => "alert-info"
        };
    }

    private string GetAlertIcon()
    {
        return tipoMensaje switch
        {
            "success" => "fa-check-circle",
            "warning" => "fa-exclamation-circle",
            "danger" => "fa-exclamation-triangle",
            _ => "fa-info-circle"
        };
    }

    private void MostrarMensaje(string tipo, string msg)
    {
        tipoMensaje = tipo;
        mensaje = msg;
        StateHasChanged();

        _ = Task.Run(async () =>
        {
            await Task.Delay(5000);
            mensaje = string.Empty;
            await InvokeAsync(StateHasChanged);
        });
    }

    private void CerrarAlerta()
    {
        mensaje = string.Empty;
    }

    public class VerificacionModel
    {
        [Required(ErrorMessage = "El código de verificación es obligatorio")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "El código debe tener 6 dígitos")]
        [RegularExpression(@"^\d{6}$", ErrorMessage = "El código debe contener solo 6 números")]
        public string CodigoVerificacion { get; set; } = string.Empty;
    }
}